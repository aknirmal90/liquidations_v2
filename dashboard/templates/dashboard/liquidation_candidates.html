{% extends "dashboard/base.html" %}

{% block title %}Liquidation Candidates | Aave Dashboard{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        border: none;
        border-radius: 16px;
        text-align: center;
        padding: 3rem 3rem;
        margin-bottom: 2rem;
    }

    .page-title {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 1rem;
    }

    .page-subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stats-card {
        text-align: center;
        padding: 2rem;
    }

    .stats-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--danger-color);
        margin-bottom: 0.5rem;
    }

    .stats-label {
        font-size: 1rem;
        color: #6b7280;
        font-weight: 500;
    }

    .table-container {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        margin-top: 2rem;
    }

    .chart-container {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        margin-top: 2rem;
        height: 500px;
    }

    .table-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        color: var(--dark-color);
    }

    .table {
        margin-bottom: 0;
    }

    .table thead th {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        font-weight: 600;
        border: none;
        padding: 1rem;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .table tbody tr {
        transition: all 0.3s ease;
    }

    .table tbody tr:hover {
        background: rgba(239, 68, 68, 0.05);
        transform: scale(1.01);
    }

    .loading-spinner {
        text-align: center;
        padding: 3rem;
        color: var(--danger-color);
    }

    .error-message {
        background: #fee;
        color: #c33;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
    }

    .user-address {
        font-family: monospace;
        font-size: 0.85rem;
    }

    .health-factor-critical {
        color: #dc2626;
        font-weight: bold;
    }

    .health-factor-warning {
        color: #f59e0b;
        font-weight: bold;
    }

    .health-factor-safe {
        color: #10b981;
        font-weight: bold;
    }

    .badge-emode {
        background: #6366f1;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .info-box {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
        padding: 1rem;
        margin-bottom: 2rem;
        border-radius: 8px;
    }

    .info-box-title {
        font-weight: 700;
        color: #92400e;
        margin-bottom: 0.5rem;
    }

    .info-box-text {
        color: #78350f;
        font-size: 0.9rem;
    }

    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
    }

    #pivot-table {
        font-size: 0.9rem;
    }

    #pivot-table th {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        font-weight: 600;
        text-align: center;
        padding: 0.75rem;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    #pivot-table th.row-header {
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        text-align: left;
        position: sticky;
        left: 0;
        z-index: 11;
    }

    #pivot-table td {
        text-align: center;
        padding: 0.75rem;
        font-weight: 500;
    }

    #pivot-table td.row-header {
        background: #f3f4f6;
        font-weight: 600;
        text-align: left;
        position: sticky;
        left: 0;
        z-index: 9;
    }

    #pivot-table td.profit-cell {
        color: #10b981;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    #pivot-table td.profit-cell:hover {
        background: rgba(16, 185, 129, 0.1);
        transform: scale(1.05);
    }

    #pivot-table td.empty-cell {
        color: #9ca3af;
        font-style: italic;
    }

    #pivot-table-container .table-responsive {
        max-height: none;
        overflow: auto;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="card page-header">
    <h1 class="page-title">
        <i class="fas fa-exclamation-circle me-3"></i>
        Liquidation Candidates
    </h1>
    <p class="page-subtitle">Users at risk of liquidation with health factors between 0.9 and 1.25 (Profit > $100)</p>
</div>

<!-- Info Box -->
<div class="info-box">
    <div class="info-box-title">
        <i class="fas fa-info-circle me-2"></i>
        Selection Criteria
    </div>
    <div class="info-box-text">
        Showing users with: <strong>Effective Debt > $10,000</strong> | <strong>Effective Collateral > $10,000</strong> |
        <strong>Health Factor: 0.9 - 1.25</strong> | <strong>Profit > $100</strong> | <strong>Debt in major assets</strong> (WETH, USDT, USDC, wstETH, USDe, WBTC)
    </div>
</div>

<!-- Filter Controls -->
<div class="card" style="padding: 1.5rem; margin-bottom: 2rem;">
    <div style="display: flex; align-items: center; gap: 1rem;">
        <div style="flex: 1;">
            <h5 style="margin: 0; font-weight: 600; color: #374151;">
                <i class="fas fa-filter me-2"></i>
                Filters
            </h5>
        </div>
        <div class="form-check form-switch" style="font-size: 1.1rem;">
            <input class="form-check-input" type="checkbox" id="excludeStablecoinPairs" style="cursor: pointer;">
            <label class="form-check-label" for="excludeStablecoinPairs" style="cursor: pointer; font-weight: 500;">
                Exclude Stablecoin Pairs (USDT/USDC)
            </label>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div id="loading-stats" class="loading-spinner">
    <i class="fas fa-spinner fa-spin fa-3x"></i>
    <p class="mt-3" id="loading-message">Loading liquidation candidates... This may take 20-30 seconds</p>
</div>

<div id="stats-content" style="display: none;">
    <div class="stats-grid">
        <div class="card stats-card">
            <div class="stats-value" id="total-candidates">-</div>
            <div class="stats-label">Total Candidates</div>
        </div>
        <div class="card stats-card">
            <div class="stats-value" id="total-debt">-</div>
            <div class="stats-label">Total Debt at Risk</div>
        </div>
        <div class="card stats-card">
            <div class="stats-value" id="total-max-profit">-</div>
            <div class="stats-label">Total Max Profit</div>
        </div>
        <div class="card stats-card">
            <div class="stats-value" id="avg-health-factor">-</div>
            <div class="stats-label">Avg Health Factor</div>
        </div>
        <div class="card stats-card">
            <div class="stats-value" id="min-health-factor">-</div>
            <div class="stats-label">Min Health Factor</div>
        </div>
    </div>

    <!-- Pivot Table Container -->
    <div class="table-container" id="pivot-table-container">
        <h2 class="table-title">
            <i class="fas fa-table-cells me-2"></i>
            Profit by Asset Pairs (Collateral Ã— Debt)
        </h2>
        <div class="table-responsive">
            <table class="table table-bordered" id="pivot-table">
                <!-- Pivot table will be populated by JavaScript -->
            </table>
        </div>
    </div>

    <!-- Chart Container -->
    <div class="chart-container" id="chart-container">
        <h2 class="table-title">
            <i class="fas fa-chart-bar me-2"></i>
            Cumulative Debt by Health Factor
        </h2>
        <canvas id="liquidation-chart"></canvas>
    </div>

    <!-- Table Container -->
    <div class="table-container" id="table-container">
        <h2 class="table-title">
            <i class="fas fa-table me-2"></i>
            Liquidation Candidates (Sorted by Health Factor - Lowest First)
        </h2>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>User Address</th>
                        <th class="text-center">Collateral</th>
                        <th class="text-center">Debt</th>
                        <th class="text-end">Health Factor</th>
                        <th class="text-end">Effective Collateral</th>
                        <th class="text-end">Effective Debt</th>
                        <th class="text-end">Max Profit</th>
                        <th class="text-center">eMode</th>
                    </tr>
                </thead>
                <tbody id="candidates-table-body">
                    <!-- Table rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="error-container"></div>
{% endblock %}

{% block extra_js %}
    // Fetch liquidation candidates from API
    async function fetchLiquidationCandidates() {
        try {
            // Get the exclude stablecoin pairs toggle state
            const excludeStablecoinPairs = document.getElementById('excludeStablecoinPairs').checked;
            const url = `/api/liquidation-candidates/?exclude_stablecoin_pairs=${excludeStablecoinPairs}`;

            console.log('Fetching liquidation candidates from', url);
            const response = await fetch(url);
            console.log('Response status:', response.status);

            if (!response.ok) {
                throw new Error(`Failed to fetch liquidation candidates: ${response.status}`);
            }
            const data = await response.json();
            console.log('Received data:', data);

            // Clear the loading timer
            if (window.loadingTimer) {
                clearInterval(window.loadingTimer);
            }

            // Update stats
            document.getElementById('total-candidates').textContent = data.total_candidates.toLocaleString();
            document.getElementById('total-debt').textContent = '$' + data.total_debt.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
            document.getElementById('total-max-profit').textContent = '$' + data.total_max_profit.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
            document.getElementById('avg-health-factor').textContent = data.avg_health_factor.toFixed(4);
            document.getElementById('min-health-factor').textContent = data.min_health_factor.toFixed(4);

            document.getElementById('loading-stats').style.display = 'none';
            document.getElementById('stats-content').style.display = 'block';

            // Populate table
            const tableBody = document.getElementById('candidates-table-body');
            tableBody.innerHTML = '';

            data.candidates.forEach((candidate, index) => {
                const row = document.createElement('tr');

                // Determine health factor color class
                let hfClass = 'health-factor-safe';
                if (candidate.health_factor < 1.00) {
                    hfClass = 'health-factor-critical';
                } else if (candidate.health_factor < 1.10) {
                    hfClass = 'health-factor-warning';
                }

                const collateralUSD = candidate.effective_collateral.toLocaleString('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });

                const debtUSD = candidate.effective_debt.toLocaleString('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });

                const maxProfitUSD = candidate.max_profit.toLocaleString('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });

                const eModebadge = candidate.is_in_emode === 1
                    ? '<span class="badge-emode">eMode</span>'
                    : '<span style="color: #9ca3af;">-</span>';

                const collateralSymbol = candidate.collateral_symbol || '-';
                const debtSymbol = candidate.debt_symbol || '-';

                row.innerHTML = `
                    <td><strong>${index + 1}</strong></td>
                    <td class="user-address">${candidate.user}</td>
                    <td class="text-center"><span style="font-weight: 600; color: #059669;">${collateralSymbol}</span></td>
                    <td class="text-center"><span style="font-weight: 600; color: #dc2626;">${debtSymbol}</span></td>
                    <td class="text-end ${hfClass}">${candidate.health_factor.toFixed(4)}</td>
                    <td class="text-end">${collateralUSD}</td>
                    <td class="text-end"><strong>${debtUSD}</strong></td>
                    <td class="text-end" style="color: #10b981; font-weight: bold;">${maxProfitUSD}</td>
                    <td class="text-center">${eModebadge}</td>
                `;

                tableBody.appendChild(row);
            });

            // Create pivot table
            createPivotTable(data.pivot_data);

            // Create chart
            createChart(data.candidates);

        } catch (error) {
            console.error('Error fetching liquidation candidates:', error);

            // Clear the loading timer
            if (window.loadingTimer) {
                clearInterval(window.loadingTimer);
            }

            document.getElementById('loading-stats').style.display = 'none';
            document.getElementById('error-container').innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading liquidation candidates: ${error.message}
                </div>
            `;
        }
    }

    function createPivotTable(pivotData) {
        console.log('Creating pivot table with', pivotData.length, 'pairs');

        // Extract unique collateral and debt assets
        const collateralAssets = [...new Set(pivotData.map(d => d.collateral_symbol))].sort();
        const debtAssets = [...new Set(pivotData.map(d => d.debt_symbol))].sort();

        console.log('Collateral assets:', collateralAssets);
        console.log('Debt assets:', debtAssets);

        // Create a map for quick lookup
        const profitMap = {};
        pivotData.forEach(d => {
            const key = `${d.debt_symbol}|${d.collateral_symbol}`;
            profitMap[key] = d.profit;
        });

        // Build the table HTML
        let tableHTML = '<thead><tr>';
        tableHTML += '<th class="row-header">Debt \\ Collateral</th>';
        collateralAssets.forEach(col => {
            tableHTML += `<th>${col}</th>`;
        });
        tableHTML += '</tr></thead><tbody>';

        // Create rows for each debt asset
        debtAssets.forEach(debt => {
            tableHTML += '<tr>';
            tableHTML += `<td class="row-header">${debt}</td>`;

            collateralAssets.forEach(col => {
                const key = `${debt}|${col}`;
                const profit = profitMap[key];

                if (profit && profit > 0) {
                    const profitFormatted = profit.toLocaleString('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    });
                    tableHTML += `<td class="profit-cell" title="Total profit: ${profitFormatted}">${profitFormatted}</td>`;
                } else {
                    tableHTML += '<td class="empty-cell">-</td>';
                }
            });

            tableHTML += '</tr>';
        });

        tableHTML += '</tbody>';

        // Insert into the table
        document.getElementById('pivot-table').innerHTML = tableHTML;
        console.log('Pivot table created successfully');
    }

    function createChart(candidates) {
        // Sort by health factor
        const sortedCandidates = [...candidates].sort((a, b) => a.health_factor - b.health_factor);

        // Calculate cumulative debt
        let cumulativeDebt = 0;
        const cumulativeData = sortedCandidates.map(candidate => {
            cumulativeDebt += candidate.effective_debt;
            return {
                health_factor: candidate.health_factor,
                cumulative_debt: cumulativeDebt
            };
        });

        const ctx = document.getElementById('liquidation-chart').getContext('2d');

        // Create gradient
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(239, 68, 68, 0.8)');
        gradient.addColorStop(1, 'rgba(239, 68, 68, 0.2)');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: cumulativeData.map((d, i) => i),
                datasets: [{
                    label: 'Cumulative Debt (USD)',
                    data: cumulativeData.map(d => d.cumulative_debt),
                    backgroundColor: gradient,
                    borderColor: '#dc2626',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const index = context[0].dataIndex;
                                return `Health Factor: ${cumulativeData[index].health_factor.toFixed(4)}`;
                            },
                            label: function(context) {
                                return 'Cumulative Debt: $' + context.parsed.y.toLocaleString('en-US', {
                                    minimumFractionDigits: 0,
                                    maximumFractionDigits: 0
                                });
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Users (sorted by health factor)',
                            font: {
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            display: false
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Cumulative Debt (USD)',
                            font: {
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString('en-US', {
                                    minimumFractionDigits: 0,
                                    maximumFractionDigits: 0
                                });
                            }
                        }
                    }
                }
            }
        });
    }

    // Load Chart.js
    const chartScript = document.createElement('script');
    chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js';
    chartScript.onload = function() {
        console.log('Chart.js loaded, fetching data...');
        fetchLiquidationCandidates();
    };
    document.head.appendChild(chartScript);

    // Add event listener to the toggle
    function initializeToggle() {
        const toggle = document.getElementById('excludeStablecoinPairs');
        if (toggle) {
            toggle.addEventListener('change', function() {
                console.log('Toggle changed, reloading data...');
                // Show loading state
                document.getElementById('stats-content').style.display = 'none';
                document.getElementById('loading-stats').style.display = 'block';
                document.getElementById('error-container').innerHTML = '';

                // Reset timer
                let seconds = 0;
                const loadingMessage = document.getElementById('loading-message');
                const timer = setInterval(() => {
                    seconds++;
                    loadingMessage.textContent = `Loading liquidation candidates... ${seconds} seconds (this may take 20-30 seconds)`;
                }, 1000);
                window.loadingTimer = timer;

                // Fetch new data
                fetchLiquidationCandidates();
            });
        }
    }

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded - starting to fetch liquidation candidates');

        // Initialize the toggle event listener
        initializeToggle();

        // Add a timer to show progress
        let seconds = 0;
        const loadingMessage = document.getElementById('loading-message');
        const timer = setInterval(() => {
            seconds++;
            loadingMessage.textContent = `Loading liquidation candidates... ${seconds} seconds (this may take 20-30 seconds)`;
        }, 1000);

        // Store timer ID so we can clear it
        window.loadingTimer = timer;
    });

    console.log('Liquidation candidates page script loaded');
{% endblock %}
