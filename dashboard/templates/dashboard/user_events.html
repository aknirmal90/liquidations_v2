{% extends 'dashboard/base.html' %}

{% block title %}User Events - Aave Asset Dashboard{% endblock %}

{% block extra_css %}
<style>
    .search-container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .token-info-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .token-address {
        font-family: monospace;
        font-size: 0.9rem;
        color: #6b7280;
        word-break: break-all;
        background: rgba(0, 0, 0, 0.05);
        padding: 0.5rem;
        border-radius: 6px;
    }

    .events-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }

    .event-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        border-left: 4px solid #6366f1;
        transition: all 0.3s ease;
    }

    .event-item:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .event-item.mint {
        border-left-color: #10b981;
    }

    .event-item.burn {
        border-left-color: #ef4444;
    }

    .event-item.transfer {
        border-left-color: #6366f1;
    }

    .event-type {
        font-weight: 600;
        color: #6366f1;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }

    .event-type.mint {
        color: #10b981;
    }

    .event-type.burn {
        color: #ef4444;
    }

    .event-type.transfer {
        color: #6366f1;
    }

    .event-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem;
        font-size: 0.9rem;
    }

    .event-detail {
        display: flex;
        flex-direction: column;
    }

    .event-label {
        font-weight: 500;
        color: #6b7280;
        font-size: 0.8rem;
        margin-bottom: 0.25rem;
    }

    .event-value {
        color: #1f2937;
        font-family: monospace;
        font-size: 0.85rem;
        word-break: break-all;
    }

    .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
    }

    .badge-event {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .badge-mint {
        background: #d1fae5;
        color: #065f46;
    }

    .badge-burn {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge-transfer {
        background: #dbeafe;
        color: #1e40af;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
    }

    .stat-label {
        font-size: 0.85rem;
        color: #6b7280;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="text-white">
                    <i class="fas fa-history me-3"></i>
                    User Events
                </h1>
            </div>

            <!-- Search Container -->
            <div class="search-container">
                <form id="searchForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-5">
                            <div class="mb-3">
                                <label for="userAddress" class="form-label text-white">User Address</label>
                                <input type="text" class="form-control" id="userAddress"
                                    placeholder="Enter user address (0x...)"
                                    style="background: rgba(255, 255, 255, 0.9);" required>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="mb-3">
                                <label for="assetAddress" class="form-label text-white">Asset Address</label>
                                <input type="text" class="form-control" id="assetAddress"
                                    placeholder="Enter asset address (0x...)"
                                    style="background: rgba(255, 255, 255, 0.9);" required>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label class="form-label text-white">&nbsp;</label>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-search me-2"></i>Search
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Loading Spinner -->
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner-border text-white" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-white mt-2">Loading events...</p>
            </div>

            <!-- Token Info -->
            <div id="tokenInfo" style="display: none;">
                <div class="token-info-card">
                    <h5 class="mb-3">
                        <i class="fas fa-coins me-2"></i>
                        Token Addresses
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-2">
                                <strong>aToken Address:</strong>
                                <div class="token-address" id="aTokenAddress"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-2">
                                <strong>Variable Debt Token Address:</strong>
                                <div class="token-address" id="variableDebtAddress"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div id="statsContainer" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="mintCount">0</div>
                        <div class="stat-label">Mint Events</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="burnCount">0</div>
                        <div class="stat-label">Burn Events</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="transferCount">0</div>
                        <div class="stat-label">Transfer Events</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalCount">0</div>
                        <div class="stat-label">Total Events</div>
                    </div>
                </div>
            </div>

            <!-- Events Container -->
            <div id="eventsContainer" style="display: none;">
                <div class="events-container">
                    <h5 class="mb-3">
                        <i class="fas fa-list me-2"></i>
                        Events for <span id="displayUser" class="text-muted" style="font-family: monospace;"></span>
                    </h5>
                    <div id="eventsList"></div>
                </div>
            </div>

            <!-- No Results -->
            <div id="noResults" style="display: none;">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5>No events found</h5>
                        <p class="text-muted">No mint, burn, or transfer events found for this user and asset combination.</p>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" style="display: none;">
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span id="errorText"></span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const searchForm = document.getElementById('searchForm');
        const userAddressInput = document.getElementById('userAddress');
        const assetAddressInput = document.getElementById('assetAddress');

        searchForm.addEventListener('submit', function (event) {
            event.preventDefault();
            searchEvents();
        });

        function searchEvents() {
            const userAddress = userAddressInput.value.trim();
            const assetAddress = assetAddressInput.value.trim();

            // Validation
            if (!userAddress || !assetAddress) {
                showError('Please enter both user address and asset address');
                return;
            }

            if (!userAddress.startsWith('0x') || userAddress.length !== 42) {
                showError('Please enter a valid user address (0x... with 42 characters)');
                return;
            }

            if (!assetAddress.startsWith('0x') || assetAddress.length !== 42) {
                showError('Please enter a valid asset address (0x... with 42 characters)');
                return;
            }

            // Show loading
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('tokenInfo').style.display = 'none';
            document.getElementById('statsContainer').style.display = 'none';
            document.getElementById('eventsContainer').style.display = 'none';
            document.getElementById('noResults').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';

            // Make API call
            fetch(`/api/user-asset-events/${userAddress}/${assetAddress}/`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('loadingSpinner').style.display = 'none';

                    if (data.error) {
                        showError(data.error);
                    } else {
                        displayResults(data, userAddress);
                    }
                })
                .catch(error => {
                    document.getElementById('loadingSpinner').style.display = 'none';
                    console.error('Error:', error);
                    showError('Failed to fetch events: ' + error.message);
                });
        }

        function getCsrfToken() {
            const tokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
            return tokenElement ? tokenElement.value : '';
        }

        function displayResults(data, userAddress) {
            // Display token addresses
            document.getElementById('aTokenAddress').textContent = data.atoken_address || 'N/A';
            document.getElementById('variableDebtAddress').textContent = data.variable_debt_address || 'N/A';
            document.getElementById('tokenInfo').style.display = 'block';

            // Check if we have events
            const events = data.events || [];
            if (events.length === 0) {
                document.getElementById('noResults').style.display = 'block';
                return;
            }

            // Calculate statistics
            const mintCount = events.filter(e => e.event_type === 'Mint').length;
            const burnCount = events.filter(e => e.event_type === 'Burn').length;
            const transferCount = events.filter(e => e.event_type === 'Transfer').length;

            document.getElementById('mintCount').textContent = mintCount;
            document.getElementById('burnCount').textContent = burnCount;
            document.getElementById('transferCount').textContent = transferCount;
            document.getElementById('totalCount').textContent = events.length;
            document.getElementById('statsContainer').style.display = 'block';

            // Display events
            document.getElementById('displayUser').textContent = userAddress;
            const eventsList = document.getElementById('eventsList');
            eventsList.innerHTML = '';

            events.forEach(event => {
                const eventItem = createEventItem(event);
                eventsList.appendChild(eventItem);
            });

            document.getElementById('eventsContainer').style.display = 'block';
        }

        function createEventItem(event) {
            const div = document.createElement('div');
            const eventClass = event.event_type.toLowerCase();
            div.className = `event-item ${eventClass}`;

            let detailsHTML = `
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="event-type ${eventClass}">
                        <span class="badge-event badge-${eventClass}">${event.event_type}</span>
                    </div>
                    <div class="text-muted" style="font-size: 0.85rem;">
                        Block: ${event.block_number}
                    </div>
                </div>
                <div class="event-details">
                    <div class="event-detail">
                        <span class="event-label">Transaction Hash</span>
                        <span class="event-value">${event.transaction_hash}</span>
                    </div>
                    <div class="event-detail">
                        <span class="event-label">Timestamp</span>
                        <span class="event-value">${formatTimestamp(event.block_timestamp)}</span>
                    </div>
                    <div class="event-detail">
                        <span class="event-label">Value</span>
                        <span class="event-value">${formatValue(event.value)}</span>
                    </div>
            `;

            if (event.event_type === 'Transfer') {
                detailsHTML += `
                    <div class="event-detail">
                        <span class="event-label">From</span>
                        <span class="event-value">${event.from_address || 'N/A'}</span>
                    </div>
                    <div class="event-detail">
                        <span class="event-label">To</span>
                        <span class="event-value">${event.to_address || 'N/A'}</span>
                    </div>
                `;
            } else if (event.event_type === 'Mint') {
                detailsHTML += `
                    <div class="event-detail">
                        <span class="event-label">On Behalf Of</span>
                        <span class="event-value">${event.on_behalf_of || 'N/A'}</span>
                    </div>
                `;
            } else if (event.event_type === 'Burn') {
                detailsHTML += `
                    <div class="event-detail">
                        <span class="event-label">From</span>
                        <span class="event-value">${event.from_address || 'N/A'}</span>
                    </div>
                    <div class="event-detail">
                        <span class="event-label">Target</span>
                        <span class="event-value">${event.target || 'N/A'}</span>
                    </div>
                `;
            }

            if (event.liquidity_index) {
                detailsHTML += `
                    <div class="event-detail">
                        <span class="event-label">Liquidity Index</span>
                        <span class="event-value">${event.liquidity_index}</span>
                    </div>
                `;
            }

            detailsHTML += '</div>';
            div.innerHTML = detailsHTML;
            return div;
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp * 1000);
            return date.toLocaleString();
        }

        function formatValue(value) {
            if (!value) return '0';
            return Number(value).toLocaleString(undefined, {
                minimumFractionDigits: 0,
                maximumFractionDigits: 6
            });
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';

            // Hide other containers
            document.getElementById('tokenInfo').style.display = 'none';
            document.getElementById('statsContainer').style.display = 'none';
            document.getElementById('eventsContainer').style.display = 'none';
            document.getElementById('noResults').style.display = 'none';
            document.getElementById('loadingSpinner').style.display = 'none';
        }
    });
</script>
{% endblock %}
